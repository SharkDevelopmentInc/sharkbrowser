function _extends(){return _extends=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},_extends.apply(this,arguments)}class IStorage{store(e,t,n){throw"IStorage store not implemented!"}retrieve(e){throw"IStorage retrieve not implemented!"}remove(e){throw"IStorage remove not implemented!"}}class Encryption{static encode(e){const t=JSON.stringify(e);return btoa?btoa(t):Buffer.from(t).toString("base64")}static decode(e){if(atob)return atob(e);const t=Buffer.from(e,"base64");return JSON.parse(t.toString("utf8"))}}const e="local";class ExtensionStorage extends IStorage{constructor(e){super(),this._syncType=e,this._event=void 0,this._keys=new Set,"none"!==this._syncType&&((chrome||{}).storage||{}).onChanged&&chrome.storage.onChanged.addListener(((e,t)=>{if(!this._event)return;if(t!==this._syncType)return;if(!this._keys.has(Object.keys(e)[0]))return;let n=JSON.parse(Encryption.decode(Object.values(e)[0].newValue));this._event(n)}))}onUpdate(e){this._event=e}store(e,t,n){var o=this;return new Promise((async function(r,c){try{if("none"===o._syncType)return void r(!0);let c={};if(n){if(Object.keys(e).length>0){let n=await o._retrieve(e,o._syncType);if(n){if(null===n[e]){const n=Encryption.encode(t);return o._store(e,n,o._syncType),o._keys.add(e),void r(!0)}if(c=Encryption.decode(n[e]),c===JSON.stringify(t))return void r(!0);let s=o.mergeDeep(JSON.parse(c),t,!0);const a=Encryption.encode(s);return o._store(e,a,o._syncType),o._keys.add(e),void r(!0)}{const n=Encryption.encode(t);return o._store(e,n,o._syncType),o._keys.add(e),void r(!0)}}}else{const n=Encryption.encode(t);o._store(e,n,o._syncType)}o._keys.add(e),r(!0)}catch(e){c(e)}}))}retrieve(e,t=null){var n=this;return new Promise((async function(o,r){try{if("none"===n._syncType)return void o(t);let r={};if(Object.keys(e).length>0){let c=await n._retrieve(e,n._syncType);if(c){r=Encryption.decode(c[e]),n._keys.add(e),o(n.mergeDeep(t,JSON.parse(r),!0))}else n._keys.add(e),o(t)}else n._keys.add(e),o(t)}catch(e){r(e)}}))}remove(e){var t=this;return new Promise((async function(n,o){try{if("none"===t._syncType)return void n(!1);if(Object.keys(e).length>0){await t._remove(e,t._syncType);t._keys.delete(e),n(!0)}}catch(e){o(e)}}))}mergeDeep(e,t,n=!1){e=(e=>{let t;try{t=JSON.parse(JSON.stringify(e))}catch(n){t=Object.assign({},e)}return t})(e);const isObject=e=>e&&"object"==typeof e;return isObject(e)&&isObject(t)?(Object.keys(t).forEach((o=>{const r=e[o],c=t[o];Array.isArray(r)&&Array.isArray(c)?n?(e[o]=r.map(((e,t)=>c.length<=t?e:this.mergeDeep(e,c[t],n))),c.length>r.length&&(e[o]=e[o].concat(c.slice(r.length)))):e[o]=r.concat(c):isObject(r)&&isObject(c)?e[o]=this.mergeDeep(Object.assign({},r),c,n):e[o]=c})),e):t}_store(e,t,n){((chrome||{}).storage||{})[this._syncType]?chrome.storage[n].set({[e]:t}):localStorage.setItem(e,t)}_retrieve(e,t){return new Promise(((n,o)=>{((chrome||{}).storage||{})[this._syncType]?chrome.storage[t].get([e],(e=>{"{}"!==JSON.stringify(e)?n(e):n(null)})):n({[e]:localStorage.getItem(e)})}))}_remove(e,t){((chrome||{}).storage||{})[this._syncType]?chrome.storage[t].remove(e):localStorage.removeItem(e)}}class PKCE{constructor(){this.code_verifier=void 0,this.code_challenge=void 0,this.storage=new ExtensionStorage(e)}async generate(){this.code_verifier=this._generateCodeVerifier(),this.code_challenge=await this._generateCodeChallengeFromVerifier(this.code_verifier);const e={challenge:this.code_challenge,verifier:this.code_verifier};return this.storage.store("rw4gc.pkce.cache",e,!0),e}async cached(){let e=await this.storage.retrieve("rw4gc.pkce.cache");return null===e&&(e=await this.generate()),e}_dec2hex(e){return("0"+e.toString(16)).substr(-2)}_generateCodeVerifier(){var e=new Uint32Array(28);return self.crypto.getRandomValues(e),Array.from(e,this._dec2hex).join("")}_sha256(e){const t=(new TextEncoder).encode(e);return self.crypto.subtle.digest("SHA-256",t)}_base64urlencode(e){for(var t="",n=new Uint8Array(e),o=n.byteLength,r=0;r<o;r++)t+=String.fromCharCode(n[r]);return btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async _generateCodeChallengeFromVerifier(e){var t=await this._sha256(e);return this._base64urlencode(t)}}const t="undefined"!=typeof chrome&&chrome.identity?chrome.identity.getRedirectURL():`${window.location.origin}/microsoftpage/mslogin.html`,n=new msal.PublicClientApplication({auth:{authority:"https://login.microsoftonline.com/common/",clientId:"0113ff4a-9673-4c71-8cba-9229b16b7ad8",redirectUri:t,postLogoutRedirectUri:t},cache:{cacheLocation:"localStorage"}}),o=n.getAllAccounts();async function authoriseStep(e,t="select_account"){const n={scopes:e,prompt:t},o=new PKCE,r=await o.cached(),c=await getLoginUrl(n,r.challenge);return await launchWebAuthFlow(c)}async function getLoginUrl(e,t){return new Promise(((o,r)=>{n.loginRedirect(_extends({},e,{code_challenge:t,code_challenge_method:"S256",onRedirectNavigate:e=>(o(e),!1)})).catch(r)}))}async function launchWebAuthFlow(e){return new Promise(((t,o)=>{chrome.identity.launchWebAuthFlow({interactive:!0,url:e},(e=>{e&&e.includes("#")?n.handleRedirectPromise(`#${e.split("#")[1]}`).then(t).catch(o):t()}))}))}function displayComplete(){document.getElementById("login_start").classList.add("gw-hidden"),document.getElementById("logout_start").classList.add("gw-hidden"),document.getElementById("login_cancelled").classList.add("gw-hidden"),document.getElementById("login_complete").classList.remove("gw-hidden")}function displayCancelled(){document.getElementById("login_start").classList.add("gw-hidden"),document.getElementById("logout_start").classList.add("gw-hidden"),document.getElementById("login_complete").classList.add("gw-hidden"),document.getElementById("login_cancelled").classList.remove("gw-hidden")}o.length&&o[0].username,async function(){const e=new Proxy(new URLSearchParams(window.location.search),{get:(e,t)=>e.get(t)}),t=e.action;let o=[];o=null===e?["user.read"]:"undefined"!==e.scopes&&e.scopes?e.scopes.split(","):["user.read"];if(t)switch(t.toLowerCase()){case"authorise":try{let e=await async function(e){let t,n=!1;try{t=await authoriseStep(e,"none"),n=!0}catch(e){}if(!n)try{t=await authoriseStep(e,"select_account"),n=!0}catch(e){throw console.log(e),e}if(void 0===t)chrome.runtime.sendMessage({command:"thswauthcancelled"});else if(n)return function(e,t){let n=!0;const o=e.map((e=>e.toLowerCase()));return t.map((e=>e.toLowerCase())).forEach((e=>{o.includes(e)||(n=!1)})),n}(t.scopes,e)||(t=await authoriseStep(e,"consent")),chrome.runtime.sendMessage({command:"thswauthorised",account:t}),t}(o);void 0===e?(displayCancelled(),setTimeout((()=>{window.close()}),3e3)):(displayComplete(),setTimeout((()=>{window.close()}),100))}catch(e){displayCancelled(),setTimeout((()=>{window.close()}),3e3)}break;case"authorisefordoccreation":await async function(e){const t=await getLoginUrl();return await launchWebAuthFlow(t)}(),displayComplete(),setTimeout((()=>{window.close()}),100);break;case"signout":document.getElementById("login_start").classList.add("gw-hidden"),document.getElementById("login_cancelled").classList.add("gw-hidden"),document.getElementById("login_complete").classList.add("gw-hidden"),document.getElementById("logout_start").classList.remove("gw-hidden"),await async function(){let e=0;try{e=n.getAllAccounts().length}catch(t){e=0}const t=n.getAllAccounts()[0],o=new PKCE,r=await o.cached();let c=null;c=t&&1===e?{account:t}:{};try{const e=await async function(e,t){return new Promise(((o,r)=>{n.logout(_extends({},e,{code_challenge:t,code_challenge_method:"S256",onRedirectNavigate:e=>(o(e),!1)})).catch(r)}))}(c,r.challenge);await launchWebAuthFlow(e)}catch(e){console.log(e)}finally{return void chrome.runtime.sendMessage({command:"thswsignedout"})}}(),displayComplete(),setTimeout((()=>{window.close()}),500)}}();
